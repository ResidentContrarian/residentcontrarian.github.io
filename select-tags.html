<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiction Recommendations - Select Tags</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            gap: 20px;
        }

        .main-area {
            flex: 1;
            background: white;
            border-radius: 20px;
            padding: 60px 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
        }

        .sidebar {
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-box {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            min-height: 120px;
        }

        .sidebar-box h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .sidebar-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 50px;
        }

        .sidebar-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .sidebar-tag .remove-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
            padding: 0;
        }

        .sidebar-tag .remove-btn:hover {
            background: rgba(255,255,255,0.5);
        }

        .excluded-tag {
            background: linear-gradient(135deg, #fc5c7d 0%, #6a82fb 100%);
        }

        .combo-tag {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .combo-separator {
            font-weight: bold;
            font-size: 12px;
        }

        .empty-message {
            color: #999;
            font-style: italic;
            font-size: 14px;
            text-align: center;
            padding: 20px 0;
        }

        .user-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .sign-out-btn {
            background: #f5f5f5;
            color: #333;
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .sign-out-btn:hover {
            background: #e8e8e8;
        }

        h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
            text-align: center;
        }

        .instruction {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.6;
            text-align: center;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
        }

        .step-indicator {
            color: #999;
            font-size: 14px;
            margin-bottom: 20px;
            text-align: center;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 40px;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .tags-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 30px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .tag-option {
            position: relative;
        }

        .tag-option input[type="checkbox"] {
            display: none;
        }

        .tag-option label {
            display: block;
            padding: 12px 16px;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .tag-option input[type="checkbox"]:checked + label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .tag-option label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        button {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        button.secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        button.secondary:hover {
            background: #e8e8e8;
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #comboInterface {
            margin-top: 30px;
        }

        .combo-builder {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .combo-builder h4 {
            color: #333;
            margin-bottom: 15px;
        }

        .combo-selects {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        select {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .combo-plus {
            font-weight: bold;
            color: #667eea;
            font-size: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-content h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .modal-content p {
            color: #666;
            margin-bottom: 20px;
            text-align: left;
        }

        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-buttons button {
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="user-menu" id="userMenu" style="display: none;">
        <span id="userEmail"></span>
        <button class="sign-out-btn" onclick="handleSignOut()">Sign Out</button>
    </div>

    <div class="main-area">
        <div class="step-indicator" id="stepIndicator">Step 1 of 3</div>
        <h1 id="phaseTitle">Select Tags You Like</h1>
        <div class="instruction" id="phaseInstruction">
            Hello! First, let's figure out what tags you like. Select as many as you want.
        </div>

        <div id="loadingMessage" class="loading">Loading tags...</div>
        <div id="errorMessage" class="error" style="display: none;"></div>

        <div id="mainContent" style="display: none;">
            <div class="tags-grid" id="tagsGrid"></div>

            <div id="comboInterface" style="display: none;">
                <div class="combo-builder">
                    <h4>Create a Combination Tag</h4>
                    <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                        Select two tags from your liked tags to combine them. We'll only show stories that have BOTH tags.
                    </p>
                    <div class="combo-selects">
                        <select id="comboTag1">
                            <option value="">Select first tag...</option>
                        </select>
                        <span class="combo-plus">+</span>
                        <select id="comboTag2">
                            <option value="">Select second tag...</option>
                        </select>
                    </div>
                    <button class="primary" onclick="createCombo()">Create Combination</button>
                </div>
            </div>

            <div class="action-buttons">
                <button type="button" class="secondary" onclick="goBack()" id="backBtn" style="display: none;">Back</button>
                <button type="button" class="secondary" onclick="skipPhase()" id="skipBtn" style="display: none;">Skip</button>
                <button type="button" class="primary" onclick="continueToNext()" id="continueBtn">Continue</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-box">
            <h3>Tags You Like</h3>
            <div class="sidebar-tags" id="likedTagsSidebar">
                <div class="empty-message">No tags selected yet</div>
            </div>
        </div>

        <div class="sidebar-box">
            <h3>Tags to Exclude</h3>
            <div class="sidebar-tags" id="excludedTagsSidebar">
                <div class="empty-message">No exclusions</div>
            </div>
        </div>

        <div class="sidebar-box">
            <h3>Combination Tags</h3>
            <div class="sidebar-tags" id="comboTagsSidebar">
                <div class="empty-message">No combinations</div>
            </div>
        </div>
    </div>

    <!-- Modal for combo tag confirmation -->
    <div class="modal" id="comboModal">
        <div class="modal-content">
            <h3>Keep Individual Tags?</h3>
            <p id="modalQuestion"></p>
            <div class="modal-buttons">
                <button class="primary" onclick="handleComboChoice('both')">Keep both individual tags</button>
                <button class="secondary" onclick="handleComboChoice('first')">Remove <span id="firstTag"></span></button>
                <button class="secondary" onclick="handleComboChoice('second')">Remove <span id="secondTag"></span></button>
                <button class="secondary" onclick="handleComboChoice('neither')">Only show the combination</button>
            </div>
        </div>
    </div>

    <script
        async
        crossorigin="anonymous"
        data-clerk-publishable-key="pk_test_bWFueS1yb2Jpbi01Ni5jbGVyay5hY2NvdW50cy5kZXYk"
        src="https://many-robin-56.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
        type="text/javascript"
    ></script>

    <script>
        let currentUser = null;
        let allTags = [];
        let currentPhase = 1; // 1 = liked, 2 = excluded, 3 = combo
        let likedTags = [];
        let excludedTags = [];
        let comboTags = [];
        let pendingCombo = null;

        window.addEventListener("load", async function () {
            await Clerk.load();

            if (!Clerk.user) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = Clerk.user;
            document.getElementById('userMenu').style.display = 'block';
            document.getElementById('userEmail').textContent = currentUser.primaryEmailAddress?.emailAddress || 'User';

            loadTags();
        });

        async function handleSignOut() {
            await Clerk.signOut();
            window.location.href = 'index.html';
        }

        async function loadTags() {
            try {
                const response = await fetch('/api/tags');
                if (!response.ok) {
                    throw new Error('Failed to fetch tags');
                }

                allTags = await response.json();
                displayTagsForPhase();
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } catch (error) {
                console.error('Error loading tags:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').textContent = 'Failed to load tags. Please try again.';
                document.getElementById('errorMessage').style.display = 'block';
            }
        }

        function displayTagsForPhase() {
            const tagsGrid = document.getElementById('tagsGrid');
            const stepIndicator = document.getElementById('stepIndicator');
            const phaseTitle = document.getElementById('phaseTitle');
            const phaseInstruction = document.getElementById('phaseInstruction');
            const skipBtn = document.getElementById('skipBtn');
            const backBtn = document.getElementById('backBtn');
            const comboInterface = document.getElementById('comboInterface');

            tagsGrid.innerHTML = '';
            comboInterface.style.display = 'none';

            if (currentPhase === 1) {
                stepIndicator.textContent = 'Step 1 of 3';
                phaseTitle.textContent = 'Select Tags You Like';
                phaseInstruction.textContent = "Hello! First, let's figure out what tags you like. Select as many as you want.";
                skipBtn.style.display = 'none';
                backBtn.style.display = 'none';

                allTags.forEach(tag => {
                    const isChecked = likedTags.includes(tag.slug);
                    const tagOption = document.createElement('div');
                    tagOption.className = 'tag-option';
                    tagOption.innerHTML = `
                        <input type="checkbox" id="tag-${tag.slug}" value="${tag.slug}" ${isChecked ? 'checked' : ''}>
                        <label for="tag-${tag.slug}">${tag.name}</label>
                    `;
                    tagsGrid.appendChild(tagOption);
                });

            } else if (currentPhase === 2) {
                stepIndicator.textContent = 'Step 2 of 3';
                phaseTitle.textContent = 'Tags to Exclude';
                phaseInstruction.textContent = "We'll show you stories with the tags you selected. Now pick any tags you want to exclude, and we'll make sure stories with those tags never show up in your feed even if they contain a tag you do like.";
                skipBtn.style.display = 'inline-block';
                backBtn.style.display = 'inline-block';

                allTags.forEach(tag => {
                    if (likedTags.includes(tag.slug)) return; // Don't show already liked tags
                    const isChecked = excludedTags.includes(tag.slug);
                    const tagOption = document.createElement('div');
                    tagOption.className = 'tag-option';
                    tagOption.innerHTML = `
                        <input type="checkbox" id="tag-${tag.slug}" value="${tag.slug}" ${isChecked ? 'checked' : ''}>
                        <label for="tag-${tag.slug}">${tag.name}</label>
                    `;
                    tagsGrid.appendChild(tagOption);
                });

            } else if (currentPhase === 3) {
                stepIndicator.textContent = 'Step 3 of 3';
                phaseTitle.textContent = 'Combination Tags (Optional)';
                phaseInstruction.innerHTML = "You can skip this step if you want, but combination tags are things like \"cozy fantasy\". If you combine two tags in the combination box, we'll only show you stories that have both tags. You'd do this if you wanted, say, military sci-fi, but not military stories or sci-fi stories in general.";
                skipBtn.style.display = 'inline-block';
                backBtn.style.display = 'inline-block';
                comboInterface.style.display = 'block';
                document.getElementById('continueBtn').textContent = 'Get Recommendations';

                // Populate combo selects
                updateComboSelects();
            }
        }

        function updateComboSelects() {
            const select1 = document.getElementById('comboTag1');
            const select2 = document.getElementById('comboTag2');

            select1.innerHTML = '<option value="">Select first tag...</option>';
            select2.innerHTML = '<option value="">Select second tag...</option>';

            likedTags.forEach(tagSlug => {
                const tag = allTags.find(t => t.slug === tagSlug);
                if (tag) {
                    select1.innerHTML += `<option value="${tag.slug}">${tag.name}</option>`;
                    select2.innerHTML += `<option value="${tag.slug}">${tag.name}</option>`;
                }
            });
        }

        function continueToNext() {
            if (currentPhase === 1) {
                // Collect liked tags
                const checked = document.querySelectorAll('#tagsGrid input[type="checkbox"]:checked');
                likedTags = Array.from(checked).map(cb => cb.value);

                if (likedTags.length === 0) {
                    alert('Please select at least one tag you like!');
                    return;
                }

                updateSidebar('liked');
                currentPhase = 2;
                displayTagsForPhase();

            } else if (currentPhase === 2) {
                // Collect excluded tags
                const checked = document.querySelectorAll('#tagsGrid input[type="checkbox"]:checked');
                excludedTags = Array.from(checked).map(cb => cb.value);

                updateSidebar('excluded');
                currentPhase = 3;
                displayTagsForPhase();

            } else if (currentPhase === 3) {
                // Save preferences and go to recommendations
                savePreferencesAndContinue();
            }
        }

        function goBack() {
            if (currentPhase === 2) {
                currentPhase = 1;
                displayTagsForPhase();
            } else if (currentPhase === 3) {
                currentPhase = 2;
                displayTagsForPhase();
            }
        }

        function skipPhase() {
            if (currentPhase === 2) {
                excludedTags = [];
                updateSidebar('excluded');
                currentPhase = 3;
                displayTagsForPhase();
            } else if (currentPhase === 3) {
                savePreferencesAndContinue();
            }
        }

        function updateSidebar(type) {
            if (type === 'liked') {
                const sidebar = document.getElementById('likedTagsSidebar');
                sidebar.innerHTML = '';
                if (likedTags.length === 0) {
                    sidebar.innerHTML = '<div class="empty-message">No tags selected yet</div>';
                } else {
                    likedTags.forEach(tagSlug => {
                        const tag = allTags.find(t => t.slug === tagSlug);
                        if (tag) {
                            const tagEl = document.createElement('div');
                            tagEl.className = 'sidebar-tag';
                            tagEl.innerHTML = `
                                <span>${tag.name}</span>
                                <button class="remove-btn" onclick="removeTag('liked', '${tagSlug}')">×</button>
                            `;
                            sidebar.appendChild(tagEl);
                        }
                    });
                }
            } else if (type === 'excluded') {
                const sidebar = document.getElementById('excludedTagsSidebar');
                sidebar.innerHTML = '';
                if (excludedTags.length === 0) {
                    sidebar.innerHTML = '<div class="empty-message">No exclusions</div>';
                } else {
                    excludedTags.forEach(tagSlug => {
                        const tag = allTags.find(t => t.slug === tagSlug);
                        if (tag) {
                            const tagEl = document.createElement('div');
                            tagEl.className = 'sidebar-tag excluded-tag';
                            tagEl.innerHTML = `
                                <span>${tag.name}</span>
                                <button class="remove-btn" onclick="removeTag('excluded', '${tagSlug}')">×</button>
                            `;
                            sidebar.appendChild(tagEl);
                        }
                    });
                }
            } else if (type === 'combo') {
                const sidebar = document.getElementById('comboTagsSidebar');
                sidebar.innerHTML = '';
                if (comboTags.length === 0) {
                    sidebar.innerHTML = '<div class="empty-message">No combinations</div>';
                } else {
                    comboTags.forEach((combo, index) => {
                        const tag1 = allTags.find(t => t.slug === combo.tag1);
                        const tag2 = allTags.find(t => t.slug === combo.tag2);
                        if (tag1 && tag2) {
                            const tagEl = document.createElement('div');
                            tagEl.className = 'sidebar-tag combo-tag';
                            tagEl.innerHTML = `
                                <span>${tag1.name}</span>
                                <span class="combo-separator">+</span>
                                <span>${tag2.name}</span>
                                <button class="remove-btn" onclick="removeCombo(${index})">×</button>
                            `;
                            sidebar.appendChild(tagEl);
                        }
                    });
                }
            }
        }

        function removeTag(type, tagSlug) {
            if (type === 'liked') {
                likedTags = likedTags.filter(t => t !== tagSlug);
                updateSidebar('liked');
                if (currentPhase === 1) displayTagsForPhase();
            } else if (type === 'excluded') {
                excludedTags = excludedTags.filter(t => t !== tagSlug);
                updateSidebar('excluded');
                if (currentPhase === 2) displayTagsForPhase();
            }
        }

        function removeCombo(index) {
            comboTags.splice(index, 1);
            updateSidebar('combo');
            updateComboSelects();
        }

        function createCombo() {
            const tag1 = document.getElementById('comboTag1').value;
            const tag2 = document.getElementById('comboTag2').value;

            if (!tag1 || !tag2) {
                alert('Please select two tags to combine');
                return;
            }

            if (tag1 === tag2) {
                alert('Please select two different tags');
                return;
            }

            // Check if this combo already exists
            const exists = comboTags.some(c =>
                (c.tag1 === tag1 && c.tag2 === tag2) || (c.tag1 === tag2 && c.tag2 === tag1)
            );

            if (exists) {
                alert('This combination already exists');
                return;
            }

            // Show modal to ask about keeping individual tags
            pendingCombo = { tag1, tag2 };
            const tag1Name = allTags.find(t => t.slug === tag1)?.name;
            const tag2Name = allTags.find(t => t.slug === tag2)?.name;

            document.getElementById('modalQuestion').textContent =
                `Do you still want to see stories with ONLY "${tag1Name}" or ONLY "${tag2Name}"? Or just the combination?`;
            document.getElementById('firstTag').textContent = tag1Name;
            document.getElementById('secondTag').textContent = tag2Name;
            document.getElementById('comboModal').classList.add('active');
        }

        function handleComboChoice(choice) {
            if (!pendingCombo) return;

            comboTags.push(pendingCombo);

            if (choice === 'neither') {
                // Remove both from liked tags
                likedTags = likedTags.filter(t => t !== pendingCombo.tag1 && t !== pendingCombo.tag2);
                updateSidebar('liked');
            } else if (choice === 'first') {
                // Remove first tag from liked
                likedTags = likedTags.filter(t => t !== pendingCombo.tag1);
                updateSidebar('liked');
            } else if (choice === 'second') {
                // Remove second tag from liked
                likedTags = likedTags.filter(t => t !== pendingCombo.tag2);
                updateSidebar('liked');
            }
            // 'both' means keep both - do nothing

            updateSidebar('combo');
            updateComboSelects();

            // Reset combo selects
            document.getElementById('comboTag1').value = '';
            document.getElementById('comboTag2').value = '';

            // Close modal
            document.getElementById('comboModal').classList.remove('active');
            pendingCombo = null;
        }

        async function savePreferencesAndContinue() {
            // For now, just store in sessionStorage
            // Later we'll save to database via API
            sessionStorage.setItem('likedTags', JSON.stringify(likedTags));
            sessionStorage.setItem('excludedTags', JSON.stringify(excludedTags));
            sessionStorage.setItem('comboTags', JSON.stringify(comboTags));

            // Navigate to recommendations
            window.location.href = 'recommendations.html';
        }
    </script>
</body>
</html>
