<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiction Recommendations - Select Tags</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .user-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .sign-out-btn {
            background: #f5f5f5;
            color: #333;
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .sign-out-btn:hover {
            background: #e8e8e8;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .step-indicator {
            color: #999;
            font-size: 14px;
            margin-bottom: 10px;
        }

        h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .instruction {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
        }

        .selected-categories {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            min-height: 80px;
            display: none;
        }

        .selected-categories.has-selections {
            display: block;
        }

        .selected-categories h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .selected-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .selected-chip {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .selected-chip .remove-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
            padding: 0;
        }

        .selected-chip .remove-btn:hover {
            background: rgba(255,255,255,0.5);
        }

        .category-boxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .category-box {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .category-box.collapsed {
            max-height: 70px;
        }

        .category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .category-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .selection-indicator {
            display: block;
            font-size: 12px;
            font-weight: 400;
            opacity: 0.9;
            margin-top: 4px;
        }

        .expand-icon {
            font-size: 24px;
            transition: transform 0.3s ease;
        }

        .category-box.collapsed .expand-icon {
            transform: rotate(-90deg);
        }

        .category-content {
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .category-box.collapsed .category-content {
            display: none;
        }

        .master-switch {
            background: #f9f9f9;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .master-switch:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .master-switch.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .master-switch input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .master-switch label {
            flex: 1;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
        }

        .sub-genres {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .tag-option {
            position: relative;
        }

        .tag-option input[type="checkbox"] {
            display: none;
        }

        .tag-option label {
            display: block;
            padding: 12px 16px;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .tag-option input[type="checkbox"]:checked + label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .tag-option label:hover:not(.disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .tag-option.disabled label {
            opacity: 0.4;
            cursor: not-allowed;
            background: #e8e8e8;
        }

        .tag-option.disabled input[type="checkbox"] {
            pointer-events: none;
        }

        .cross-category-badge {
            display: inline-block;
            background: #f093fb;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
            font-weight: 600;
        }

        .action-buttons {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        button {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        button.secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        button.secondary:hover {
            background: #e8e8e8;
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 40px;
            font-size: 18px;
        }

        .error {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            color: #c33;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="user-menu" id="userMenu" style="display: none;">
        <span id="userEmail"></span>
        <button class="sign-out-btn" onclick="handleSignOut()">Sign Out</button>
    </div>

    <div class="container">
        <div id="loadingMessage" class="loading">Loading tags...</div>
        <div id="errorMessage" class="error" style="display: none;"></div>

        <div id="mainContent" style="display: none;">
            <div class="header">
                <div class="step-indicator" id="stepIndicator">Step 1 of 3</div>
                <h1 id="phaseTitle">Select Genres You Like</h1>
                <p class="instruction" id="phaseInstruction">
                    Select entire genres using "All [Genre]" or pick specific sub-genres. Cross-genre tags appear in multiple boxes.
                </p>
            </div>

            <div class="selected-categories" id="selectedCategoriesBox">
                <h3 id="selectedCategoriesHeader">Your Selections</h3>
                <div class="selected-chips" id="selectedChips"></div>
            </div>

            <div class="category-boxes" id="categoryBoxes"></div>

            <div class="action-buttons">
                <button type="button" class="secondary" onclick="goBack()" id="backBtn" style="display: none;">Back</button>
                <button type="button" class="secondary" onclick="skipPhase()" id="skipBtn" style="display: none;">Skip</button>
                <button type="button" class="primary" onclick="continueToNext()" id="continueBtn">Continue</button>
            </div>
        </div>
    </div>

    <script
        async
        crossorigin="anonymous"
        data-clerk-publishable-key="pk_test_bWFueS1yb2Jpbi01Ni5jbGVyay5hY2NvdW50cy5kZXYk"
        src="https://many-robin-56.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
        type="text/javascript"
    ></script>

    <script>
        let currentUser = null;
        let allTags = [];
        let currentPhase = 1; // 1 = genre selection, 2 = genre exclusions, 3 = content exclusions

        // Data structure for selections
        let selectedTags = []; // Array of tag slugs
        let excludedTags = []; // Array of tag slugs (used in phase 2)
        let excludedContent = []; // Array of content warning slugs (used in phase 3)

        // Cache for organizing tags by category
        let tagsByCategory = {};
        let masterSwitches = {};
        let contentWarnings = [];

        // Track which categories are collapsed
        let collapsedCategories = new Set();

        window.addEventListener("load", async function () {
            await Clerk.load();

            if (!Clerk.user) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = Clerk.user;
            document.getElementById('userMenu').style.display = 'block';
            document.getElementById('userEmail').textContent = currentUser.primaryEmailAddress?.emailAddress || 'User';

            loadTags();
        });

        async function handleSignOut() {
            await Clerk.signOut();
            window.location.href = 'index.html';
        }

        async function loadTags() {
            try {
                const response = await fetch('/api/tags');
                if (!response.ok) {
                    throw new Error('Failed to fetch tags');
                }

                allTags = await response.json();
                organizeTags();
                displayPhase();

                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } catch (error) {
                console.error('Error loading tags:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                const errorEl = document.getElementById('errorMessage');
                errorEl.textContent = 'Failed to load tags. Please try again.';
                errorEl.style.display = 'block';
            }
        }

        function organizeTags() {
            // Organize tags by category and type
            tagsByCategory = {};
            masterSwitches = {};
            contentWarnings = [];

            allTags.forEach(tag => {
                if (tag.tag_type === 'content_warning') {
                    contentWarnings.push(tag);
                    return;
                }

                if (tag.is_master_switch) {
                    const category = tag.categories[0];
                    masterSwitches[category] = tag;
                    if (!tagsByCategory[category]) {
                        tagsByCategory[category] = [];
                    }
                } else {
                    // Add tag to all its categories
                    tag.categories.forEach(category => {
                        if (!tagsByCategory[category]) {
                            tagsByCategory[category] = [];
                        }
                        tagsByCategory[category].push(tag);
                    });
                }
            });

            // Sort tags within each category by display_order
            Object.keys(tagsByCategory).forEach(category => {
                tagsByCategory[category].sort((a, b) => a.display_order - b.display_order);
            });
        }

        function displayPhase() {
            const stepIndicator = document.getElementById('stepIndicator');
            const phaseTitle = document.getElementById('phaseTitle');
            const phaseInstruction = document.getElementById('phaseInstruction');
            const skipBtn = document.getElementById('skipBtn');
            const backBtn = document.getElementById('backBtn');
            const continueBtn = document.getElementById('continueBtn');

            if (currentPhase === 1) {
                // Phase 1: Genre Selection
                stepIndicator.textContent = 'Step 1 of 3';
                phaseTitle.textContent = 'Select Genres You Like';
                phaseInstruction.textContent = 'Select entire genres using "All [Genre]" or pick specific sub-genres. Cross-genre tags appear in multiple boxes.';
                skipBtn.style.display = 'none';
                backBtn.style.display = 'none';
                continueBtn.textContent = 'Continue';

                renderGenreBoxes();
            } else if (currentPhase === 2) {
                // Phase 2: Genre Exclusions - clear collapsed state so all boxes are open
                collapsedCategories.clear();

                stepIndicator.textContent = 'Step 2 of 3';
                phaseTitle.textContent = 'Exclude Genres (Optional)';
                phaseInstruction.textContent = 'Select genres or sub-genres to exclude. These will NEVER show up, even if they match your liked tags.';
                skipBtn.style.display = 'inline-block';
                backBtn.style.display = 'inline-block';
                continueBtn.textContent = 'Continue';

                renderGenreBoxes();
            } else if (currentPhase === 3) {
                // Phase 3: Content Exclusions - clear collapsed state
                collapsedCategories.clear();

                stepIndicator.textContent = 'Step 3 of 3';
                phaseTitle.textContent = 'Content Filters (Optional)';
                phaseInstruction.textContent = 'Exclude content you prefer not to see, like graphic violence or explicit content.';
                skipBtn.style.display = 'inline-block';
                backBtn.style.display = 'inline-block';
                continueBtn.textContent = 'Get Recommendations';

                renderContentWarnings();
            }

            updateSelectedChips();
        }

        function renderGenreBoxes() {
            const container = document.getElementById('categoryBoxes');
            container.innerHTML = '';

            // Get categories sorted by display_order of their master switches
            const categories = Object.keys(tagsByCategory).sort((a, b) => {
                const orderA = masterSwitches[a]?.display_order || 999;
                const orderB = masterSwitches[b]?.display_order || 999;
                return orderA - orderB;
            });

            categories.forEach(category => {
                const masterSwitch = masterSwitches[category];
                const tags = tagsByCategory[category];

                const box = document.createElement('div');
                box.className = 'category-box';
                box.id = `category-${category}`;

                // Determine selection status for this category
                const isMasterSelected = masterSwitch && (
                    currentPhase === 1 ? selectedTags.includes(masterSwitch.slug) : excludedTags.includes(masterSwitch.slug)
                );

                // Count individual tags selected in this category (not including master switch)
                const categoryTagsSelected = tags.filter(tag => {
                    return currentPhase === 1 ? selectedTags.includes(tag.slug) : excludedTags.includes(tag.slug);
                });

                // Build selection indicator
                let selectionIndicator = '';
                if (isMasterSelected) {
                    const text = currentPhase === 2 ? 'All Excluded!' : 'All Selected!';
                    selectionIndicator = `<span class="selection-indicator">${text}</span>`;
                } else if (categoryTagsSelected.length > 0) {
                    const text = currentPhase === 2 ? `${categoryTagsSelected.length} excluded` : `${categoryTagsSelected.length} selected`;
                    selectionIndicator = `<span class="selection-indicator">${text}</span>`;
                }

                const header = document.createElement('div');
                header.className = 'category-header';
                header.onclick = () => toggleCategory(category);
                header.innerHTML = `
                    <div>
                        <h2>${masterSwitch ? masterSwitch.name.replace('All ', '') : category}</h2>
                        ${selectionIndicator}
                    </div>
                    <span class="expand-icon">▼</span>
                `;

                const content = document.createElement('div');
                content.className = 'category-content';

                // Master switch
                if (masterSwitch) {
                    const isSelected = currentPhase === 1
                        ? selectedTags.includes(masterSwitch.slug)
                        : excludedTags.includes(masterSwitch.slug);

                    const masterDiv = document.createElement('div');
                    masterDiv.className = `master-switch ${isSelected ? 'selected' : ''}`;
                    masterDiv.innerHTML = `
                        <input type="checkbox"
                               id="tag-${masterSwitch.slug}"
                               value="${masterSwitch.slug}"
                               ${isSelected ? 'checked' : ''}
                               onchange="handleMasterSwitch('${category}', '${masterSwitch.slug}', this.checked)">
                        <label for="tag-${masterSwitch.slug}">${masterSwitch.name}</label>
                    `;
                    content.appendChild(masterDiv);
                }

                // Sub-genres
                const subGenresDiv = document.createElement('div');
                subGenresDiv.className = 'sub-genres';

                tags.forEach(tag => {
                    const isSelected = currentPhase === 1
                        ? selectedTags.includes(tag.slug)
                        : excludedTags.includes(tag.slug);
                    const isDisabled = shouldTagBeDisabled(tag);
                    const isCrossCategory = tag.categories.length > 1;

                    const tagOption = document.createElement('div');
                    tagOption.className = `tag-option ${isDisabled ? 'disabled' : ''}`;
                    tagOption.innerHTML = `
                        <input type="checkbox"
                               id="tag-${tag.slug}"
                               value="${tag.slug}"
                               ${isSelected ? 'checked' : ''}
                               ${isDisabled ? 'disabled' : ''}
                               onchange="handleTagChange('${tag.slug}', this.checked)">
                        <label for="tag-${tag.slug}" class="${isDisabled ? 'disabled' : ''}">
                            ${tag.name}
                            ${isCrossCategory ? '<span class="cross-category-badge">COMBO</span>' : ''}
                        </label>
                    `;
                    subGenresDiv.appendChild(tagOption);
                });

                content.appendChild(subGenresDiv);
                box.appendChild(header);
                box.appendChild(content);
                container.appendChild(box);

                // Restore collapsed state
                if (collapsedCategories.has(category)) {
                    box.classList.add('collapsed');
                }
            });
        }

        function renderContentWarnings() {
            const container = document.getElementById('categoryBoxes');
            container.innerHTML = '';

            const box = document.createElement('div');
            box.className = 'category-box';

            const header = document.createElement('div');
            header.className = 'category-header';
            header.innerHTML = `
                <h2>Content Warnings</h2>
            `;

            const content = document.createElement('div');
            content.className = 'category-content';

            const grid = document.createElement('div');
            grid.className = 'sub-genres';

            if (contentWarnings.length === 0) {
                // Show a message if no content warnings are found
                grid.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        <p style="margin-bottom: 10px;">No content warning tags found in database.</p>
                        <p style="font-size: 14px;">Run the <code>tag-taxonomy-migration.sql</code> migration to add content warning tags.</p>
                    </div>
                `;
            } else {
                contentWarnings.forEach(tag => {
                    const isSelected = excludedContent.includes(tag.slug);

                    const tagOption = document.createElement('div');
                    tagOption.className = 'tag-option';
                    tagOption.innerHTML = `
                        <input type="checkbox"
                               id="tag-${tag.slug}"
                               value="${tag.slug}"
                               ${isSelected ? 'checked' : ''}
                               onchange="handleContentWarning('${tag.slug}', this.checked)">
                        <label for="tag-${tag.slug}">${tag.name}</label>
                    `;
                    grid.appendChild(tagOption);
                });
            }

            content.appendChild(grid);
            box.appendChild(header);
            box.appendChild(content);
            container.appendChild(box);
        }

        function shouldTagBeDisabled(tag) {
            // Check if any of the tag's categories have their master switch selected
            // which should gray out this tag
            if (currentPhase === 1) {
                // In selection mode, master switches gray out child tags
                return tag.categories.some(category => {
                    const masterSwitch = masterSwitches[category];
                    return masterSwitch && selectedTags.includes(masterSwitch.slug);
                });
            } else if (currentPhase === 2) {
                // In exclusion mode, same logic applies
                return tag.categories.some(category => {
                    const masterSwitch = masterSwitches[category];
                    return masterSwitch && excludedTags.includes(masterSwitch.slug);
                });
            }
            return false;
        }

        function toggleCategory(category) {
            const box = document.getElementById(`category-${category}`);
            if (box.classList.contains('collapsed')) {
                box.classList.remove('collapsed');
                collapsedCategories.delete(category);
            } else {
                box.classList.add('collapsed');
                collapsedCategories.add(category);
            }
        }

        function handleMasterSwitch(category, slug, checked) {
            if (currentPhase === 1) {
                if (checked) {
                    selectedTags.push(slug);
                    // Auto-collapse this category
                    setTimeout(() => toggleCategory(category), 300);
                } else {
                    selectedTags = selectedTags.filter(t => t !== slug);
                }
            } else if (currentPhase === 2) {
                if (checked) {
                    excludedTags.push(slug);
                    setTimeout(() => toggleCategory(category), 300);
                } else {
                    excludedTags = excludedTags.filter(t => t !== slug);
                }
            }

            // Re-render to update disabled states
            renderGenreBoxes();
            updateSelectedChips();
        }

        function handleTagChange(slug, checked) {
            // Update the tag in the appropriate array
            if (currentPhase === 1) {
                if (checked) {
                    if (!selectedTags.includes(slug)) {
                        selectedTags.push(slug);
                    }
                } else {
                    selectedTags = selectedTags.filter(t => t !== slug);
                }
            } else if (currentPhase === 2) {
                if (checked) {
                    if (!excludedTags.includes(slug)) {
                        excludedTags.push(slug);
                    }
                } else {
                    excludedTags = excludedTags.filter(t => t !== slug);
                }
            }

            // Re-render all boxes to sync cross-category tags
            renderGenreBoxes();
            updateSelectedChips();
        }

        function handleContentWarning(slug, checked) {
            if (checked) {
                excludedContent.push(slug);
            } else {
                excludedContent = excludedContent.filter(t => t !== slug);
            }
            updateSelectedChips();
        }

        function updateSelectedChips() {
            const chipsContainer = document.getElementById('selectedChips');
            const selectedBox = document.getElementById('selectedCategoriesBox');
            const headerEl = document.getElementById('selectedCategoriesHeader');

            // Update header text based on phase
            if (currentPhase === 1) {
                headerEl.textContent = 'Your Selections';
            } else if (currentPhase === 2) {
                headerEl.textContent = 'Your Exclusions (you won\'t see these!)';
            } else if (currentPhase === 3) {
                headerEl.textContent = 'Content You\'re Excluding';
            }

            let displayTags = [];
            if (currentPhase === 1) {
                displayTags = selectedTags;
            } else if (currentPhase === 2) {
                displayTags = excludedTags;
            } else if (currentPhase === 3) {
                displayTags = excludedContent;
            }

            if (displayTags.length === 0) {
                selectedBox.classList.remove('has-selections');
                return;
            }

            selectedBox.classList.add('has-selections');
            chipsContainer.innerHTML = '';

            displayTags.forEach(slug => {
                const tag = allTags.find(t => t.slug === slug);
                if (tag) {
                    const chip = document.createElement('div');
                    chip.className = 'selected-chip';
                    chip.innerHTML = `
                        <span>${tag.name}</span>
                        <button class="remove-btn" onclick="removeSelection('${slug}')">×</button>
                    `;
                    chipsContainer.appendChild(chip);
                }
            });
        }

        function removeSelection(slug) {
            if (currentPhase === 1) {
                selectedTags = selectedTags.filter(t => t !== slug);
                const checkbox = document.getElementById(`tag-${slug}`);
                if (checkbox) checkbox.checked = false;
                renderGenreBoxes();
            } else if (currentPhase === 2) {
                excludedTags = excludedTags.filter(t => t !== slug);
                const checkbox = document.getElementById(`tag-${slug}`);
                if (checkbox) checkbox.checked = false;
                renderGenreBoxes();
            } else if (currentPhase === 3) {
                excludedContent = excludedContent.filter(t => t !== slug);
                const checkbox = document.getElementById(`tag-${slug}`);
                if (checkbox) checkbox.checked = false;
            }
            updateSelectedChips();
        }

        function continueToNext() {
            if (currentPhase === 1) {
                if (selectedTags.length === 0) {
                    alert('Please select at least one genre or sub-genre!');
                    return;
                }
                currentPhase = 2;
                displayPhase();
            } else if (currentPhase === 2) {
                currentPhase = 3;
                displayPhase();
            } else if (currentPhase === 3) {
                savePreferencesAndContinue();
            }
        }

        function goBack() {
            if (currentPhase === 2) {
                currentPhase = 1;
                displayPhase();
            } else if (currentPhase === 3) {
                currentPhase = 2;
                displayPhase();
            }
        }

        function skipPhase() {
            if (currentPhase === 2) {
                excludedTags = [];
                currentPhase = 3;
                displayPhase();
            } else if (currentPhase === 3) {
                excludedContent = [];
                savePreferencesAndContinue();
            }
        }

        async function savePreferencesAndContinue() {
            // Store preferences in sessionStorage
            sessionStorage.setItem('selectedTags', JSON.stringify(selectedTags));
            sessionStorage.setItem('excludedTags', JSON.stringify(excludedTags));
            sessionStorage.setItem('excludedContent', JSON.stringify(excludedContent));

            // Navigate to recommendations
            window.location.href = 'recommendations.html';
        }
    </script>
</body>
</html>
