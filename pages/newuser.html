<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Create your page</title>
  <style>
    body { font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 24px; }
    .step { margin-bottom: 20px; }
    .hidden { display: none; }
    button { padding: 8px 14px; }
    .tags { display: grid; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap: 8px; max-width: 680px; }
    label { display: flex; gap: 8px; align-items: center; }
  </style>
</head>
<body>
  <h1>Make your page</h1>

  <!-- Step 1: username -->
  <div id="step1" class="step">
    <h3>1) Pick a username</h3>
    <input id="username" placeholder="e.g. jacob" />
    <button id="toStep2">Next</button>
  </div>

  <!-- Step 2: choose tags -->
  <div id="step2" class="step hidden">
    <h3>2) What tags do you like?</h3>
    <div id="tags" class="tags">Loading tagsâ€¦</div>
    <button id="toStep3">Continue</button>
  </div>

  <!-- Step 3: generate -->
  <div id="step3" class="step hidden">
    <h3>3) Generate your page</h3>
    <button id="generate">Generate & go</button>
  </div>

  <script>
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const usernameEl = document.getElementById('username');
    const tagsEl = document.getElementById('tags');

    let tagList = [];
    let chosenTagIds = [];
    let username = "";

    document.getElementById('toStep2').onclick = async () => {
      username = usernameEl.value.trim();
      if (!username) { alert('Enter a username'); return; }
      step1.classList.add('hidden');
      step2.classList.remove('hidden');

      // load tags from DB
      const res = await fetch('/api/get-tags');
      tagList = await res.json();
      tagsEl.innerHTML = '';
      tagList.forEach(t => {
        const id = `tag-${t.id}`;
        const wrap = document.createElement('label');
        wrap.innerHTML = `<input type="checkbox" id="${id}" value="${t.id}"><span>${t.name}</span>`;
        tagsEl.appendChild(wrap);
      });
    };

    document.getElementById('toStep3').onclick = () => {
      chosenTagIds = Array.from(document.querySelectorAll('#tags input:checked')).map(i => Number(i.value));
      if (!chosenTagIds.length) { alert('Pick at least one tag'); return; }
      step2.classList.add('hidden');
      step3.classList.remove('hidden');
    };

    document.getElementById('generate').onclick = async () => {
      // create/update user + preferences, then redirect
      const res = await fetch('/api/create-user', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ username, likedTagIds: chosenTagIds })
      });
      if (!res.ok) { const e = await res.json(); alert(e.error || 'Error'); return; }
      location.href = `/u/${encodeURIComponent(username)}`;
    };
  </script>
</body>
</html>
